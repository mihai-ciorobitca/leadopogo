<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instagram Checker</title>
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body {
            background-image: url(/static/background.png);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f1f1f1;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            padding: 10px;
            background: white;
            width: 70%;
            height: 70vh;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        label {
            display: inline-block;
            margin: 20px;
            padding: 10px 20px;
            background-color: #1dc955;
            color: white;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        input[type="checkbox"] {
            margin-right: 8px;
            appearance: none;
            width: 20px;
            height: 20px;
            background-color: #fff;
            border: 2px solid #1dc955;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        input[type="checkbox"]:checked {
            background-color: #1dc955;
            border-color: #1dc955;
        }

        input[type="checkbox"]:checked:after {
            content: '\2713';
            font-size: 16px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        input {
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        #localStorageContent {
            background-color: white;
            width: 100%;
            max-height: 50vh;
            overflow-y: auto;
            border-radius: 0 0 15px 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead {
            background: linear-gradient(to left, #15D040, #469FBF);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th {
            color: white;
        }

        th, td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ccc;
            border-left: none;
        }


        .copy-button, select, .remove-button {
            padding: 10px;
            width: 100%;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        .copy-button, button, .remove-button {
            background-color: #1dc955;
            color: white;
            cursor: pointer;
            margin: 5px 0;
        }

        .copy-button:hover, .remove-button:hover {
            background-color: #15D040;
        }

        #downloadButton, #uploadButton,
        #addButton, #removeButton {
            padding: 10px 20px;
            background-color: #469FBF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }

        #downloadButton {
            margin-left: auto;
        }

         .buttonsContainer {
            display: inline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="localStorageContent">
            <div id="localStorageContent">
                <table>
                    <thead>
                        <tr>
                            <th>Delete</th>
                            <th>Phone</th>
                            <th>Link</th>
                            <th>Check</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="buttonsContainer">
            <button id="addButton" style="width: 20%">Add option</button>
            <button id="removeButton" style="width: 20%">Remove option</button>
            <button for="fileInput" id="uploadButton" style="width: 20%">Upload</button>
            <button id="downloadButton" style="width: 20%">Download</button>
            <input id="addInput" style="width: 45%" placeholder="Write here the option..."/>
            <input id="fileName" style="width: 45%" placeholder="Write filename here..."/>
        </div>
    </div>
    <input type="file" id="fileInput" accept=".csv">
    <script>
        const fileInput = document.getElementById('fileInput');
        const tableBody = document.querySelector('#localStorageContent tbody');
        const downloadButton = document.getElementById('downloadButton');

        // Data array to store the table data
        let tableData = [];

        // Function to refresh the table
        function refreshTable() {
            tableBody.innerHTML = '';
            tableData.forEach((data, index) => {
                const row = document.createElement('tr');

                // Create a button for the phone
                const removeCell = document.createElement('td');
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-button';
                removeButton.textContent = "Remove";
                removeButton.addEventListener('click', function() {
                    const confirmation = confirm("Are you sure you want to remove this option?");
                    if (confirmation) {
                        // Call removeRow function to remove the corresponding row
                        removeRow(index);
                    }
                });
                removeCell.appendChild(removeButton);

                // Create a button for the phone
                const phoneCell = document.createElement('td');
                const phoneButton = document.createElement('button');
                phoneButton.textContent = data.phone;
                phoneButton.className = 'copy-button';
                phoneButton.addEventListener('click', function() {
                    copyToClipboard(data.phone);
                });
                phoneCell.appendChild(phoneButton);

                // Create a button for the link
                const linkCell = document.createElement('td');
                const linkButton = document.createElement('button');
                linkButton.textContent = data.url;
                linkButton.className = 'copy-button';
                linkButton.addEventListener('click', function() {
                    openInstagramProfile(data.url);
                });
                linkCell.appendChild(linkButton);

                const checkCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = data.checked; // Add checked property from the data
                checkbox.addEventListener('change', function() {
                    data.checked = checkbox.checked; // Update the data with the checked status
                    updateLocalStorage(); // Update the localStorage when checkbox changes
                });
                checkCell.appendChild(checkbox);

                const selectCell = document.createElement('td');
                const container = document.createElement('div');
                container.className = 'custom-dropdown';

                const selectElement = document.createElement('select');
                selectElement.className = 'copy-button';

                const optionsString = localStorage.getItem('options');
                const options = optionsString ? JSON.parse(optionsString) : [];

                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.text = option;
                    selectElement.appendChild(optionElement);
                });

                selectElement.value = data.category || "";
                selectElement.addEventListener('change', function () {
                    const selectedOption = selectElement.value;
                    tableData[index].category = selectedOption;
                    updateLocalStorage();
                    localStorage.setItem(`selectedOption${index}`, selectedOption);
                });

                selectCell.appendChild(selectElement);

                row.appendChild(removeCell);
                row.appendChild(phoneCell);
                row.appendChild(linkCell);
                row.appendChild(checkCell);
                row.appendChild(selectCell);
                tableBody.appendChild(row);
            });
        }

        fileInput.addEventListener('change', function() {
            const selectedFile = fileInput.files[0];
            const reader = new FileReader();

            // Inside the FileReader onload event
            reader.onload = function(event) {
                const fileContent = event.target.result;
                const lines = fileContent.split('\n');
                tableData = [];

                lines.forEach(line => {
                    const [phone, url] = line.split(',');
                    if (phone && url) {
                        tableData.push({ phone, url });
                    }
                });

                updateLocalStorage();
                refreshTable();
                status.textContent = 'File content has been saved to local storage.';
            };

            reader.readAsText(selectedFile);
        });

        document.getElementById('uploadButton').addEventListener('click', function(event) {
            event.preventDefault();
            fileInput.click();
        });

        document.getElementById('addButton').addEventListener("click", function(event) {
            const inputValue = document.getElementById('addInput').value
            const optionsString = localStorage.getItem('options');
            let options = optionsString ? JSON.parse(optionsString) : [];

            if (inputValue && !options.includes(inputValue)) {
                options.push(inputValue); // Add the new option to the options array
                localStorage.setItem('options', JSON.stringify(options)); // Update the options in local storage
                refreshTable();
                alert("Option added");
            } else {
                alert("Please enter a valid and unique option.");
            }
        });

        document.getElementById('removeButton').addEventListener("click", function(event) {
            const inputValue = document.getElementById('addInput').value
            const optionsString = localStorage.getItem('options');
            let options = optionsString ? JSON.parse(optionsString) : [];

            if (inputValue && options.includes(inputValue)) {
                const indexToRemove = options.indexOf(inputValue);

                if (indexToRemove !== -1) {
                    options.splice(indexToRemove, 1); // Remove the element at indexToRemove
                    localStorage.setItem('options', JSON.stringify(options)); // Update the options in local storage
                    refreshTable();
                    alert("Option removed");
                } else {
                    alert("An error occurred while removing the option.");
                }
            } else {
                alert("Please enter a valid and unique option.");
            }

        });

        function removeRow(index) {
            // Remove the row from the table
            tableData.splice(index, 1);
            refreshTable();

            // Update localStorage with the new tableData
            updateLocalStorage();
        }

        // Check if locally stored content exists
        function loadFromLocalStorage() {
            const savedContent = localStorage.getItem('uploadedFileContent');
            if (savedContent) {
                tableData = JSON.parse(savedContent);
                refreshTable();
            }
        }

        // Function to update localStorage with tableData
        function updateLocalStorage() {
            localStorage.setItem('uploadedFileContent', JSON.stringify(tableData));
        }

        loadFromLocalStorage();

        // Download button click event
        downloadButton.addEventListener('click', function() {
            const checkedData = tableData.filter(data => data.checked);
            if (checkedData.length > 0) {
                const csvContent = checkedData.map(data => {
                    const phone = data.phone !== undefined ? data.phone.trim() : '';
                    const url = data.url !== undefined ? data.url.trim() : '';
                    const category = data.category !== undefined ? data.category.trim() : '';

                    return `${phone},${url},${category}`;
                }).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                fileName = document.getElementById('fileName').value;
                if (fileName != '') {
                    a.download = `${fileName}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                else {
                    alert('Write name of file before download');
                }
            } else {
                alert('No records are checked for download.');
            }
        });

        document.getElementById('removeButton').addEventListener("click", function(event) {
            const inputValue = document.getElementById('addInput').value;
            const optionsString = localStorage.getItem('options');
            let options = optionsString ? JSON.parse(optionsString) : [];

            if (inputValue && options.includes(inputValue)) {
                const indexToRemove = options.indexOf(inputValue);

                if (indexToRemove !== -1) {
                    options.splice(indexToRemove, 1); // Remove the element at indexToRemove
                    localStorage.setItem('options', JSON.stringify(options)); // Update the options in local storage
                    refreshTable();
                    alert("Option removed");
                } else {
                    alert("An error occurred while removing the option.");
                }
            } else {
                alert("Please enter a valid and unique option.");
            }
        });

        function copyToClipboard(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert("Number copied to clipboard");
        }

        // Function to open an Instagram profile in a new tab
        function openInstagramProfile(profile) {
            const isLink = profile.includes('instagram.com');
            if (isLink) {
                window.open(profile, '_blank');
            } else {
                const instagramUrl = `https://www.instagram.com/${profile}/`;
                window.open(instagramUrl, '_blank');
            }
        }

    </script>
</body>
</html>
